# Migration from 7.0 to 8.0

## Breaking changes

### Minimum requirements

The following versions are supported when issues arise.

- Ember 4.12 and above
- Node 20 and above
- `@ember/test-helpers` 4.x and above


### Removed `app/formats.js` support

If you want reusable formats (these are optional), define them in `app/ember-intl.{js,ts}`. This file replaces `app/formats.js`.

```ts
/* app/ember-intl.ts */
import type { Formats } from 'ember-intl';

export const formats: Formats = {
  formatTime: {
    hhmmss: {
      hour: 'numeric',
      minute: 'numeric',
      second: 'numeric',
    },
  },
};
```

Note, the key names now match the names of the `intl` service methods (and the names of the helpers in strict mode):

| Usage in `intl` service | Key (before) | Key (after) |
|--|--|--|
| `formatDate()` | date | formatDate |
| `formatDateRange()` | dateTimeRange | formatDateRange |
| `formatNumber()` | number | formatNumber |
| `formatRelativeTime()` | relative | formatRelativeTime |
| `formatTime()` | time | formatTime |

<br>

Unlike with `app/formats.js`, `ember-intl` doesn't automatically (magically) read your formats. You use standard JavaScript to import and consume them. (You may see that formats can then live in any file. For standardization, `app/ember-intl.{js,ts}` is recommended.)

```ts
/* app/routes/application.ts */
import Route from '@ember/routing/route';
import { type Registry as Services, service } from '@ember/service';
import { formats } from 'my-app/ember-intl';

export default class ApplicationRoute extends Route {
  @service declare intl: Services['intl'];

  beforeModel() {
    this.intl.setFormats(formats);
    this.intl.setLocale(['en-us']);
  }
}
```

Since formats are set in the `application` route, your rendering and unit tests may need additional setup if they depend on a particular format.

```ts
import { formats } from 'my-app/ember-intl';

module('Integration | Component | my-component', function (hooks) {
  setupIntl(hooks, 'en-us');

  hooks.beforeEach(function () {
    const intl = this.owner.lookup('service:intl');
    intl.setFormats(formats);
  });
});
```


### Removed `/blueprints`

Until now, you could run `ember install ember-intl`, which caused files in `/blueprints` to create the files `config/ember-intl.js` (for overriding build options) and `translations/en-us.yaml` (for defining translations).

Using `ember install` to do a post-install is a remnant from classic Ember. It blurs the separation of concerns and isn't what `ember-intl` as a v2 addon should keep supporting. There are better ways to scaffold files (e.g. allow copy-pastes from the documentation site, run a codemod).

It also made sense to remove `/blueprints` for a few more reasons:

- The default values for build options should work well for most projects.
- Some may want to use `*.json` or another locale as their default choice.
- A smaller bundle size can be achieved. 

If you have a new project, you will need to create these files manually. If you want to override the build options, see [Build options](../advanced/build-options) for more information.


### Removed build options

Before `v6`, the number of build options that can be configured became too much. The more build options `ember-intl` allows, the harder it is to maintain code, standardize usage, and pave a way forward for Vite apps.

In `v8`, `ember-intl` will continue to support these options:

```ts
const defaultConfig = {
  errorOnMissingTranslations: false,
  errorOnNamedArgumentMismatch: false,
  fallbackLocale: undefined,
  inputPath: 'translations',
  publicOnly: false,
  wrapTranslationsWithNamespace: false,
};
```

Conversely, it no longer supports these options:

- `excludeLocales`
- `includeLocales`
- `outputPath`
- `requiresTranslation`
- `stripEmptyTranslations`
- `verbose` (see [Removed skipped translation validations](#removed-skipped-translation-validations) below)


### Removed loading of translations

For more information, see [V2 addon](#v2-addon) below.


### Removed skipped translation validations

The `verbose` option had a long-present bug: It had allowed a couple of validations to be skipped. Now that `verbose` is gone, if you have used the [`plural`](https://formatjs.github.io/docs/core-concepts/icu-syntax/#plural-format) or [`select`](https://formatjs.github.io/docs/core-concepts/icu-syntax/#select-format) format in translations, you may see additional logs (prefixed with `[ember-intl]`) when you run `ember serve`. These logs won't cause your builds to fail.

For example, only the category of `other` is supported in `plural` for the Chinese language. Using `one` causes validation to fail, so you will want to remove it.

```diff
/
-   "errors": "错误{count, plural, one {} other {}}"
+   "errors": "错误{count, plural, other {}}"
}
```

To handle specific counts, use number matching (`=#`) instead of `zero`, `one`, etc.

```json
{
  "errors": "错误{count, plural, =0 {无错误} =1 {1个错误} other {#个错误}}"
}
```

Visit [Language Plural Rules](https://www.unicode.org/cldr/charts/48/supplemental/language_plural_rules.html) to see the categories that each language supports.


### Renamed `formatRelative()` and `{{format-relative}}`

It was unclear from the name what exactly is being compared (relative to what?).

The method and the corresponding helper are called `formatRelativeTime()` and `{{format-relative-time}}` in `v8`.

```diff
// For *.{gjs,gts,js,ts} files
- this.intl.formatRelative(-1);
+ this.intl.formatRelativeTime(-1);
```

```diff
{{! For *.hbs files }}
<div>
-   Past: {{format-relative -1}}
+   Past: {{format-relative-time -1}}
</div>
```

```diff
// For *.{gjs,gts} files
- import { formatRelative } from 'ember-intl';
+ import { formatRelativeTime } from 'ember-intl';

<template>
  <div>
-     Past: {{formatRelative -1}}
+     Past: {{formatRelativeTime -1}}
  </div>
</template>
```


### Simplified message for `setOnMissingTranslation()` in tests

When a translation is missing, the `intl` service uses [`setOnMissingTranslation()`](../services/intl-part-2#setonmissingtranslation-) to display some string. The default value for development and production has been `Missing translation "${key}" for locale "${locale}"`. The value is different for testing.

Until now, `setupIntl()` replaced the default value with a string that weakly asserts the translation key and data. The code that converts data (an arbitrary object) to a string wasn't easy to maintain. It increased the package size while providing limited value, since we can't know from weak assertions what our end-users see in reality.

In `v8`, `setupIntl()` uses a simpler value, one that only asserts the translation key.

```diff
// Without data
- assert.dom().hasText('t:hello.message:()');
+ assert.dom().hasText('t:hello.message');

// With data
- assert.dom().hasText('t:hello.message:("name":"Zoey")');
+ assert.dom().hasText('t:hello.message');
```

Again, the best way is to ensure that translations are loaded in tests, so that you can write assertions that are strong and don't leak implementation details.

```diff
- assert.dom().hasText('t:hello.message:("name":"Zoey")');
+ assert.dom().hasText('Hello, Zoey!');
```

If you can't load translations and want to weakly assert data, call `setOnMissingTranslation()` in your custom `setupRenderingTest()`.

```ts
/* tests/helpers/index.ts */
import { setupIntl } from 'ember-intl/test-support';
import {
  setupRenderingTest as upstreamSetupRenderingTest,
  type SetupTestOptions,
} from 'ember-qunit';

function setupRenderingTest(hooks: NestedHooks, options?: SetupTestOptions) {
  upstreamSetupRenderingTest(hooks, options);
  setupIntl(hooks, 'en-us');

  hooks.beforeEach(function () {
    const intl = this.owner.lookup('service:intl');

    intl.setOnMissingTranslation((key, _locale, data) => {
      // Return some string
    });
  });
}

export { setupRenderingTest };
```


## Features

### V2 addon

`ember-intl` is now a v2 addon. It continues to provide the following, now pre-built:

- Helpers
- `intl` service
- Test helpers
- Native types for Glint
- Barrel file for templates in strict mode
- Template registry for templates in loose mode

What it no longer provides is the loading of translations. To ensure that all existing projects can use `ember-intl` as a v2 addon, the package `@ember-intl/v1-compat` has been created. It loads translations in an almost identical way as `ember-intl@v7` does.

Therefore, when you update `ember-intl` to `v8`, you may need to install `@ember-intl/v1-compat` as a development dependency.

- Apps need `@ember-intl/v1-compat`.
- V1 addons need it if their `dummy` app needs translations for documentation or testing.
- V2 addons don't need it.

Live reload didn't "just work" in Vite apps with `ember-intl@v7`, so `@ember-intl/v1-compat` (with the same implementation) doesn't fix the issue. The workarounds included [running `vite --force`](https://github.com/ember-intl/ember-intl/issues/1958#issue-2936842184) (to clear the cache) and [having one translation file per locale](https://github.com/ember-intl/ember-intl/issues/1958#issuecomment-2863762708).

There will be a separate package for loading translations in Vite apps. Until it's provided, you may use `@ember-intl/v1-compat` or a custom solution.


### `{{t-key}}` helper

In JavaScript files (`*.{gjs,gts,js,ts}`), you can use `tKey()` to mark strings that are actually translation keys. This will help programs (e.g. linters, codemods) check how you use translations.

For more information and examples, see [`{{t-key}}`](../helpers/t-key).
